---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

<!-- README.md is generated from README.Rmd. Please edit that file -->

# osmextract

<!-- badges: start -->

[![R build status](https://github.com/itsleeds/osmextract/workflows/R-CMD-check/badge.svg)](https://github.com/itsleeds/osmextract/actions)
<!-- badges: end -->

The goal of `osmextract` is to make it easier for R
users to access freely available, community created geographic data, in
the form of OpenSteetMap data extracted by providers such as [Geofabrik
GmbH](http://download.geofabrik.de) and [bbbike](https://download.bbbike.org/osm/).
For information on alternatives and how to add them see the [providers vignette](https://itsleeds.github.io/osmextract/articles/providers.html).

## Why osmextract?

[`osmdata`](https://github.com/ropensci/osmdata) provides an R interface
to the [Overpass API](https://wiki.openstreetmap.org/wiki/Overpass_API),
which is ideal for downloading small OSM datasets. However, the API is
rate limited, making it hard to download large datasets. As a case
study, letâ€™s try to download all cycleways in England:

```r
library(osmdata)
cycleways_england = opq("England") %>% 
  add_osm_feature(key = "highway", value = "cycleway") %>% 
  osmdata_sf()
# Error in check_for_error(doc) : General overpass server error; returned:
# The data included in this document is from www.openstreetmap.org. The data is made available under ODbL. runtime error: Query timed out in "query" at line 4 after 26 seconds. 
```

The query hanged with an error message after around 10 seconds. The same query can be made with `osmextract` as follows, which reads-in almost 100k linestrings in less than 10 seconds (after the data has been downloaded in the compressed `.pbf` format and converted to the open standard `.gpkg` format, not evaluated):

```{r}
library(osmextract)
```


```{r, eval=FALSE}
cycleways_england = oe_get(
  "England",
  quiet = FALSE,
  query = "SELECT * FROM 'lines' WHERE highway = 'cycleway'"
)
plot(sf::st_geometry(cycleways_england))
```

<img src="https://user-images.githubusercontent.com/1825120/87085554-f77e8b00-c227-11ea-914a-936b8be23132.png" width="100%" />

The package is designed to complement `osmdata` which has advantages
over `osmextract` for small datasets: `osmdata` is likely to be quicker
for datasets less than ~10 MB, provides up-to-date data and has an
intuitive interface. `osmdata` can provide data in a range of formats,
while `osmextract` only returns [`sf`](https://github.com/r-spatial/sf)
objects. On the other hand, `osmextract` provides a fast way to download
large OSM datasets in the highly compressed `pbf` format and read them
in via the fast C library
[GDAL](https://gdal.org/drivers/vector/osm.html) and the R package
[`sf`](https://github.com/r-spatial/sf).

## Installation

<!-- You can install the released version of osmextract from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->

<!-- install.packages("osmextract") -->

<!-- ``` -->

You can install the development version from
[GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("ITSLeeds/osmextract")
```

Load the package with:

```{r}
library(osmextract)
```

To use alongside functionality in the `sf` package we also recommend attaching this geographic data package as follows:

```{r}
library(sf)
```


## Usage

Give `osmextract` the name of a geofabrik zone and it will download and
import it.
By default it imports the 'lines' layer, but any layer can be read-in. 

## Importing OSM data

The function `oe_get()` downloads (if not already downloaded) and reads-in data from OSM extract providers as an `sf` object:

```{r}
iow = oe_get("Isle of Wight", stringsAsFactors = FALSE)
class(iow)
names(iow) # default variable names
```

Once imported, we can use all the functions for data frames in base R and other packages.
We can also use functions from the `sf` package for spatial analysis and visualisation.
Let's plot all the major and minor roads, for example:

```{r iow1}
iow_major_roads = iow[iow$highway %in% c("primary", "secondary"), ]
plot(iow_major_roads["highway"])
```

The same steps can be used to get other OSM datasets (note use of `quiet = FALSE` to show additional message, examples not run):

```{r, eval=FALSE}
test_malta = oe_get("Malta", quiet = FALSE)
ncol(test_malta)
test_andorra = oe_get("Andorra", extra_attributes = "ref", quiet = FALSE)
ncol(test_andorra)
```

## Queries

Some files from providers such as geofabrik are large.
You may therefore want to check the contents before importing them.
To do this you can use an SQL query that is passed to GDAL via `sf`.
To check the values stored in the highway column for our Isle of Wight example, for example, run the following command: 

```{r}
oe_get(
  "Isle of Wight", 
  query = "SELECT DISTINCT highway FROM \"lines\" "
)
```

The values will vary.
There are more types of highway in the Andorra dataset, for example:

```{r}
oe_get(
  "Andorra", 
  query = "SELECT DISTINCT highway FROM \"lines\" "
)
```

The same `query` argument can be used to read-in only certain features, all primary roads in Andorra for example: 

```{r, iow2}
# and select only one of them: 
iow_primary = oe_get(
  "Isle of Wight", 
  extra_attributes = "ref", 
  quiet = FALSE, 
  query = "SELECT * FROM 'lines' WHERE highway IN ('primary')"
)
class(iow_primary)
plot(iow_primary$geometry)
```

This is substantially faster and less memory intensive than reading-in the whole dataset and filtering with R.

You can use [GDAL's SQL syntax](https://gdal.org/user/ogr_sql_dialect.html) to get the result you need.
Let's get all primary and secondary roads, for example:

```{r, iow3}
iow_major_roads2 = oe_get(
  "Isle of Wight", 
  extra_attributes = "ref", 
  quiet = FALSE, 
  query = "SELECT * FROM 'lines' WHERE highway IN ('primary', 'secondary')"
)
plot(iow_major_roads2["highway"])
```

You can also use regex, as shown in the following command that gets roads that are likely to be walking and cycling friendly:

```{r, iow4}
iow_active_travel = oe_get(
  "Isle of Wight", 
  extra_attributes = "ref", 
  quiet = FALSE, 
  query = "SELECT * FROM 'lines' WHERE highway IN ('cycleway', 'living_street', 'residential')"
)
plot(iow_active_travel["highway"])
```

## Other providers

At present `geofabrik` and `bbbike` providers are supported.
An example showing how to use an alternative provider is shown in the example below.

```{r, eval=FALSE}
leeds = oe_get(place = "Leeds", provider = "bbbike", quiet = FALSE)
names(leeds)
#> [1] "osm_id"     "name"       "highway"    "waterway"   "aerialway"  "barrier"    "man_made"   "z_order"    "other_tags" "geometry"  
plot(leeds$geometry)
```


```{r, echo=FALSE}
knitr::include_graphics("https://user-images.githubusercontent.com/1825120/87104595-46d8b180-c250-11ea-878f-8936c0a7bd30.png")
```

## Next steps

We hope to make the user interface to the SQL syntax more user friendly.
We would love to see more providers added (see the [Add new OpenStreetMap providers](https://itsleeds.github.io/osmextract/articles/providers.html) for details) and see what people can do with OSM datasets of the type provided by this package in a reproducible and open statistical programming environment for the greater good.
Any contributions to support this or any other improvements to the package are very welcome via our issue tracker.

## Licence

We hope this package will provide easy access to OSM data for reproducible research in the public interest, adhering to the condition of the [OdBL licence](https://opendatacommons.org/licenses/odbl/) which states that

> Any Derivative Database that You Publicly Use must be only under the terms of:

- i. This License;
- ii. A later version of this License similar in spirit to this

## Other approaches

<!-- todo: add links to other packages -->
- [osmdata](https://github.com/ropensci/osmdata) is an R package for importing small datasets directly from OSM servers
- [pyrosm](https://pyrosm.readthedocs.io/en/latest/) is a Python package for reading .pbf files
- [OpenStreetMapX.jl](https://github.com/pszufe/OpenStreetMapX.jl) is a Julia package for reading and analysing .osm files
- [PostGIS](https://www.bostongis.com/PrinterFriendly.aspx?content_name=loading_osm_postgis) is an established spatial database that works well with large OSM datasets
- Any others? Let us know!

<!-- :) -->

