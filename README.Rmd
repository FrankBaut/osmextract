---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# geofabric

<!-- badges: start -->
[![Travis build status](https://travis-ci.org/itsleeds/geofabric.svg?branch=master)](https://travis-ci.org/itsleeds/geofabric)
<!-- badges: end -->

The goal of geofabric is to make it easier for open source software users to access freely available, community created geographic data, in the form of OpenSteetMap data shipped by [Geofabrik GmbH](http://download.geofabrik.de).

## Installation

<!-- You can install the released version of geofabric from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("geofabric") -->
<!-- ``` -->
You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ITSLeeds/geofabric")
```
## Usage

Give geofabric the name of a geofabric zone and it will download and import it.
By default it imports the 'lines' layer, but any layer can be read-in.
Behind the scenes, the function `read_pbf()`, a wrapper around `sf::st_read()` is used with configuration options to import additional columns from the .pbf files not imported by default, including `maxspeed`, `lanes` and `oneway` (the attributes to include can be set with `attributes` argument):

```{r example}
library(geofabric)
andorra_lines = get_geofabric(name = "andorra", layer = "lines")
names(andorra_lines)
andorra_point = get_geofabric(name = "andorra", layer = "points", attributes = "shop")
names(andorra_point) # note the 'shop' column has been added
plot(andorra_lines$geometry)
plot(andorra_point[andorra_point$shop == "supermarket", ], col = "red", add = TRUE)
```

The above code plotted lines representing roads and other linear features in Andorra, with an overlay of shops that are represented in OSM data.
If there are no files available for a zone name, geofabric will search for and import the nearest matching zone:

```{r matching}
iow_lines = get_geofabric(name = "isle wight")
```

Take care: files downloaded from geofabrik can be large.
You can find information on the geofabrik region defining the boundaries of the result with `gf_find()`: 

```{r}
iow_gf_region = gf_find("isle wight")
plot(iow_gf_region)
iow_gf_name = iow_gf_region$name
iow_gf_name
```

If you want to use `st_read()` to read-in the .pbf files, e.g. to set additional query arguments, you can do so, as demonstrated below.

```{r query}
iow_gf_file = gf_filename(iow_gf_name)
iow_gf_file
file.exists(iow_gf_file)
iow_lines_cycle = read_pbf(dsn = iow_gf_file, "lines", key = "highway", value = "cycleway")
plot(iow_lines_cycle)
```

If you want even more control, you can used GDAL's `query` argument via `sf`:

```{r}
query = paste0("select highway from lines where highway = ",
               "'cycleway' or highway = 'secondary' or highway = 'primary'")
iow_lines_subset = sf::st_read(iow_gf_file, layer = "lines", query = query)
plot(iow_lines_subset)
```

You can also get your geofabric data based on a spatial query, for example in Honduras:

```{r}
library(geofabric)
place_sf = sf::st_as_sf(data.frame(x = -86, y = 15, n = 1),
                        coords = c("x", "y"), crs = 4326)
osm_data_place = get_geofabric(place_sf)
plot(osm_data_place["highway"])
```


# geofabrik zones

The package ships with a data frame representing all zones made available by the package.
These can be interactively searched with the following command:

```{r, eval=FALSE}
View(sf::st_drop_geometry(geofabric_zones[1:3]))
```

That will display the following table in the viewer:

```{r viewer, echo=FALSE}
knitr::kable(sf::st_drop_geometry(geofabric_zones[1:4, 1:3]))
```

The following attributes are available from this file if you want more info about each geofabric zone:

```{r cols}
names(geofabric_zones)
```

Each geographic level (continents, countries, regions and subregions) is shown in the map below, with a few of them named for reference.

```{r zonemap}
# todo: tidy up geofabric_zones data and this code chunk
library(tmap)
sel1 = is.na(geofabric_zones$level)
geofabric_zones$level[sel1] = 1
geofabric_zones$label = ""
geofabric_zones$label[sel1] = geofabric_zones$name[sel1]
set.seed(9)
sel2 = sample(x = 1:nrow(geofabric_zones), size = 5)
geofabric_zones$label[sel2] = geofabric_zones$name[sel2]
tm_shape(geofabric_zones) +
  tm_polygons() +
  tm_text(text = "label") +
  tm_facets(by = "level")
```

A couple of the countries, regions and sub regions available is shown below.

```{r viewer-countries}
geofabric_countries = geofabric_zones[geofabric_zones$level == 2, ]
knitr::kable(sf::st_drop_geometry(geofabric_countries[1:2, 1:3]))
```

```{r viewer-regions}
geofabric_regions = geofabric_zones[geofabric_zones$level == 3, ]
knitr::kable(sf::st_drop_geometry(geofabric_regions[1:2, 1:3]))
```

```{r viewer-subregions}
geofabric_subregions = geofabric_zones[geofabric_zones$level == 4, ]
knitr::kable(sf::st_drop_geometry(geofabric_subregions[1:2, 1:3]))
```

```{r old, echo=FALSE, eval=FALSE}
get_geofabric(continent = "europe", country = "great-britain")
# Download a specific region as follows:
# get_geofabric(continent = "europe", country = "great-britain", region = "wales")
# get_geofabric(continent = "europe", country = "italy", region = "nord-este")
```

