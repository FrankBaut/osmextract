---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# geofabrik

<!-- badges: start -->
[![Travis build status](https://travis-ci.org/itsleeds/geofabric.svg?branch=master)](https://travis-ci.org/itsleeds/geofabric)
<!-- badges: end -->

The goal of `geofabrik` is to make it easier for open source software users to access freely available, community created geographic data, in the form of OpenSteetMap data shipped by [Geofabrik GmbH](http://download.geofabrik.de).

## Why geofabrik?

[`osmdata`](https://github.com/ropensci/osmdata) provides an R interface to the [Overpass API](https://wiki.openstreetmap.org/wiki/Overpass_API), which is ideal for downloading small OSM datasets. However, the API is rate limited, making it hard to download large datasets.
As a case study, let's try to download all cycleways in England:

```{r, eval=FALSE}
library(osmdata)
cycleways_england = opq("England") %>% 
  add_osm_feature(key = "highway", value = "cycleway") %>% 
  osmdata_sf()
# Error in check_for_error(doc) : General overpass server error; returned:
# The data included in this document is from www.openstreetmap.org. The data is made available under ODbL. runtime error: Query timed out in "query" at line 4 after 26 seconds. 
```

The query hanged with an error message after around 10 seconds.
The same query can be made with `geofabrik` as follows (not evaluated):

```{r}
library(geofabrik)
```

```{r, eval=FALSE}
cycleways_england = get_geofabrik("England", key = "highway", value = "cycleway")
plot(sf::st_geometry(cycleways_england))
```

<img src="man/figures/README-unnamed-chunk-3-1.png" width="100%" />

The package is designed to complement `osmdata` which has advantages over `geofabrik` for small datasets: `osmdata` is likely to be quicker for datasets less than ~10 MB, provides up-to-date data and has an intuitive interface.
`osmdata` can provide data in a range of formats, while `geofabrik` only returns [`sf`](https://github.com/r-spatial/sf) objects.
On the other hand, `geofabrik` provides a fast way to download large OSM datasets in the highly compressed `pbf` format and read them in via the fast C library [GDAL](https://gdal.org/drivers/vector/osm.html) and the R package [`sf`](https://github.com/r-spatial/sf).


## Installation

<!-- You can install the released version of geofabrik from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("geofabrik") -->
<!-- ``` -->
You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ITSLeeds/geofabrik")
```
## Usage

Give `geofabrik` the name of a geofabrik zone and it will download and import it.
By default it imports the 'lines' layer, but any layer can be read-in.
Behind the scenes, the function `read_pbf()`, a wrapper around `sf::st_read()` is used with configuration options to import additional columns from the `.pbf` files not imported by default, including `maxspeed`, `lanes` and `oneway` (the attributes to include can be set with `attributes` argument):

```{r example}
andorra_lines = get_geofabrik(name = "andorra", layer = "lines")
names(andorra_lines)
andorra_point = get_geofabrik(name = "andorra", layer = "points", attributes = "shop")
names(andorra_point) # note the 'shop' column has been added
plot(sf::st_geometry(andorra_lines))
plot(andorra_point[andorra_point$shop == "supermarket", ], col = "red", add = TRUE)
```

The above code plotted lines representing roads and other linear features in Andorra, with an overlay of shops that are represented in OSM data.
If there are no files available for a zone name, `geofabrik` will search for and import the nearest matching zone:

```{r matching}
iow_lines = get_geofabrik(name = "isle wight")
```

Take care: files downloaded from [geofabrik.de](http://download.geofabrik.de) can be large.
You can find information on the geofabrik region defining the boundaries of the result with `gf_find()`: 

```{r}
iow_gf_region = gf_find("isle wight")
plot(iow_gf_region)
iow_gf_name = iow_gf_region$name
iow_gf_name
```

If you want to use `st_read()` to read-in the `.pbf` files, e.g. to set additional query arguments, you can do so, as demonstrated below.

```{r query}
iow_gf_file = gf_filename(iow_gf_name)
iow_gf_file
file.exists(iow_gf_file)
iow_lines_cycle = read_pbf(dsn = iow_gf_file, "lines", key = "highway", value = "cycleway")
plot(iow_lines_cycle)
```

If you want even more control, you can used GDAL's `query` argument via `sf`:

```{r}
query = paste0("select highway from lines where highway = ",
               "'cycleway' or highway = 'secondary' or highway = 'primary'")
iow_lines_subset = sf::st_read(iow_gf_file, layer = "lines", query = query)
plot(iow_lines_subset)
```

<!-- TODO: FIX THE FOLLOWING PART SINCE IT DOESN'T WORK -->
<!-- You can also get your geofabrik data based on a spatial query, for example in Honduras: -->

<!-- ```{r} -->
<!-- library(geofabrik) -->
<!-- place_sf = sf::st_as_sf(data.frame(x = -86, y = 15, n = 1), -->
<!--                         coords = c("x", "y"), crs = 4326) -->
<!-- osm_data_place = get_geofabrik(place_sf) -->
<!-- plot(osm_data_place["highway"]) -->
<!-- ``` -->


# geofabrik zones

The package ships with a data frame representing all zones made available by the package.
These can be interactively searched with the following command:

```{r, eval=FALSE}
View(sf::st_drop_geometry(geofabrik_zones[1:3]))
```

That will display the following table in the viewer:

```{r viewer, echo=FALSE}
knitr::kable(sf::st_drop_geometry(geofabrik_zones[1:4, 1:3]))
```

The following attributes are available from this file if you want more info about each geofabrik zone:

```{r cols}
names(geofabrik_zones)
```

Each geographic level (continents, countries, regions and subregions) is shown in the map below, with a few of them named for reference.

```{r zonemap}
# todo: tidy up geofabrik_zones data and this code chunk
library(tmap)
sel1 = is.na(geofabrik_zones$level)
geofabrik_zones$level[sel1] = 1
geofabrik_zones$label = ""
geofabrik_zones$label[sel1] = geofabrik_zones$name[sel1]
set.seed(9)
sel2 = sample(x = 1:nrow(geofabrik_zones), size = 5)
geofabrik_zones$label[sel2] = geofabrik_zones$name[sel2]
tm_shape(geofabrik_zones) +
  tm_polygons() +
  tm_text(text = "label") +
  tm_facets(by = "level")
```

A couple of the countries, regions and sub regions available is shown below.

```{r viewer-countries}
geofabrik_countries = geofabrik_zones[geofabrik_zones$level == 2, ]
knitr::kable(sf::st_drop_geometry(geofabrik_countries[1:2, 1:3]))
```

```{r viewer-regions}
geofabrik_regions = geofabrik_zones[geofabrik_zones$level == 3, ]
knitr::kable(sf::st_drop_geometry(geofabrik_regions[1:2, 1:3]))
```

```{r viewer-subregions}
geofabrik_subregions = geofabrik_zones[geofabrik_zones$level == 4, ]
knitr::kable(sf::st_drop_geometry(geofabrik_subregions[1:2, 1:3]))
```

```{r old, echo=FALSE, eval=FALSE}
get_geofabrik(continent = "europe", country = "great-britain")
# Download a specific region as follows:
# get_geofabrik(continent = "europe", country = "great-britain", region = "wales")
# get_geofabrik(continent = "europe", country = "italy", region = "nord-este")
```
